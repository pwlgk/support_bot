# bot/gpt/yagpt_integration.py
import logging
import aiohttp
import json
from config import YAGPT_API_KEY, YAGPT_FOLDER_ID, YAGPT_ENABLED_BY_DEFAULT

# --- –°–æ—Å—Ç–æ—è–Ω–∏–µ –º–æ–¥—É–ª—è ---
is_gpt_enabled: bool = YAGPT_ENABLED_BY_DEFAULT
# ----------------------

# URL API YandexGPT (–∏—Å–ø–æ–ª—å–∑—É–µ–º chatCompletions)
YAGPT_API_URL = "https://llm.api.cloud.yandex.net/foundationModels/v1/completion"
# –ú–æ–¥–µ–ª—å (–º–æ–∂–Ω–æ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥—É—é, –Ω–∞–ø—Ä–∏–º–µ—Ä, yandexgpt)
MODEL_URI = f"gpt://{YAGPT_FOLDER_ID}/yandexgpt-lite"

# –ó–∞–≥–æ–ª–æ–≤–∫–∏ –¥–ª—è –∑–∞–ø—Ä–æ—Å–∞
HEADERS = {
    "Authorization": f"Api-Key {YAGPT_API_KEY}",
    "Content-Type": "application/json"
}

# –°–∏—Å—Ç–µ–º–Ω—ã–π –ø—Ä–æ–º–ø—Ç (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ, –∑–∞–¥–∞–µ—Ç –ø–æ–≤–µ–¥–µ–Ω–∏–µ –º–æ–¥–µ–ª–∏)
#SYSTEM_PROMPT = "–¢—ã ‚Äî –≤–µ–∂–ª–∏–≤—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏. –û—Ç–≤–µ—á–∞–π –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∫—Ä–∞—Ç–∫–æ –∏ –ø–æ –¥–µ–ª—É. –ï—Å–ª–∏ –Ω–µ –∑–Ω–∞–µ—à—å –æ—Ç–≤–µ—Ç–∞ –∏–ª–∏ –≤–æ–ø—Ä–æ—Å –Ω–µ –ø–æ —Ç–µ–º–µ, –≤–µ–∂–ª–∏–≤–æ —Å–æ–æ–±—â–∏ –æ–± —ç—Ç–æ–º."

SYSTEM_PROMPT = """–¢—ã ‚Äî –≤–µ–∂–ª–∏–≤—ã–π –∏ –ø—Ä–æ—Ñ–µ—Å—Å–∏–æ–Ω–∞–ª—å–Ω—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç —Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –≤ Telegram-–±–æ—Ç–µ. –¢–≤–æ—è –≥–ª–∞–≤–Ω–∞—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ–≥–∞—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è–º (–∫–ª–∏–µ–Ω—Ç–∞–º) –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å —Å –±–æ—Ç–æ–º –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∏ –æ—Ç—Å–ª–µ–∂–∏–≤–∞–Ω–∏—è –∑–∞—è–≤–æ–∫ –Ω–∞ —Ä–µ–º–æ–Ω—Ç –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è –∏–ª–∏ —Ä–µ—à–µ–Ω–∏–µ –¥—Ä—É–≥–∏—Ö —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö –ø—Ä–æ–±–ª–µ–º.

–í–æ—Ç –æ—Å–Ω–æ–≤–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏, –¥–æ—Å—Ç—É–ø–Ω—ã–µ **–∫–ª–∏–µ–Ω—Ç–∞–º** —á–µ—Ä–µ–∑ –±–æ—Ç–∞:

1.  **–ù–∞—á–∞–ª–æ —Ä–∞–±–æ—Ç—ã (`/start`):**
    *   –†–µ–≥–∏—Å—Ç—Ä–∏—Ä—É–µ—Ç –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –∏–ª–∏ –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤—É–µ—Ç —Å—É—â–µ—Å—Ç–≤—É—é—â–µ–≥–æ.
    *   –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –æ—Å–Ω–æ–≤–Ω—É—é –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É —Å –¥–æ—Å—Ç—É–ø–Ω—ã–º–∏ –¥–µ–π—Å—Ç–≤–∏—è–º–∏.

2.  **–°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–∏ (–ö–Ω–æ–ø–∫–∞ "üìù –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É" –∏–ª–∏ –∫–æ–º–∞–Ω–¥–∞ `/new_request`):**
    *   –ó–∞–ø—É—Å–∫–∞–µ—Ç –ø–æ—à–∞–≥–æ–≤—ã–π –ø—Ä–æ—Ü–µ—Å—Å —Å–±–æ—Ä–∞ –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ (FSM).
    *   –ë–æ—Ç –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ –∑–∞–ø—Ä–∞—à–∏–≤–∞–µ—Ç —É –∫–ª–∏–µ–Ω—Ç–∞:
        *   –§–ò–û (–º–æ–∂–µ—Ç –±—ã—Ç—å –ø—Ä–µ–¥–∑–∞–ø–æ–ª–Ω–µ–Ω–æ)
        *   –ö–æ—Ä–ø—É—Å, –≥–¥–µ –≤–æ–∑–Ω–∏–∫–ª–∞ –ø—Ä–æ–±–ª–µ–º–∞.
        *   –ö–∞–±–∏–Ω–µ—Ç –∏–ª–∏ –Ω–æ–º–µ—Ä –ø–æ–º–µ—â–µ–Ω–∏—è.
        *   –ü–æ–¥—Ä–æ–±–Ω–æ–µ –æ–ø–∏—Å–∞–Ω–∏–µ –ø—Ä–æ–±–ª–µ–º—ã.
        *   –ò–Ω–≤–µ–Ω—Ç–∞—Ä–Ω—ã–π –Ω–æ–º–µ—Ä –ü–ö –∏–ª–∏ –æ–±–æ—Ä—É–¥–æ–≤–∞–Ω–∏—è (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ, –º–æ–∂–Ω–æ –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å).
        *   –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π –Ω–æ–º–µ—Ä —Ç–µ–ª–µ—Ñ–æ–Ω–∞.
    *   –ü–æ—Å–ª–µ –≤–≤–æ–¥–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö –∑–∞—è–≤–∫–∞ —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç—Å—è —Å–æ —Å—Ç–∞—Ç—É—Å–æ–º "–û–∂–∏–¥–∞–µ—Ç –ø—Ä–∏–Ω—è—Ç–∏—è".
    *   –ö–ª–∏–µ–Ω—Ç –ø–æ–ª—É—á–∞–µ—Ç –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —Å –Ω–æ–º–µ—Ä–æ–º –∑–∞—è–≤–∫–∏.
    *   –ò–Ω–∂–µ–Ω–µ—Ä—ã –ø–æ–ª—É—á–∞—é—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ –Ω–æ–≤–æ–π –∑–∞—è–≤–∫–µ.

3.  **–ü—Ä–æ—Å–º–æ—Ç—Ä —Å–≤–æ–∏—Ö –∑–∞—è–≤–æ–∫ (–ö–Ω–æ–ø–∫–∞ "üìÑ –ú–æ–∏ –∑–∞—è–≤–∫–∏" –∏–ª–∏ –∫–æ–º–∞–Ω–¥–∞ `/my_requests`):**
    *   –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –∫–ª–∏–µ–Ω—Ç—É —Å–ø–∏—Å–æ–∫ –µ–≥–æ —Ç–µ–∫—É—â–∏—Ö –∑–∞—è–≤–æ–∫ (–∫–æ—Ç–æ—Ä—ã–µ –Ω–µ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã/–∞—Ä—Ö–∏–≤–∏—Ä–æ–≤–∞–Ω—ã –∏ –Ω–µ –æ—Ç–º–µ–Ω–µ–Ω—ã).
    *   –î–ª—è –∫–∞–∂–¥–æ–π –∑–∞—è–≤–∫–∏ –æ—Ç–æ–±—Ä–∞–∂–∞–µ—Ç—Å—è:
        *   –ù–æ–º–µ—Ä (#ID).
        *   –î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è.
        *   –¢–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å ("–û–∂–∏–¥–∞–µ—Ç –ø—Ä–∏–Ω—è—Ç–∏—è" –∏–ª–∏ "–í —Ä–∞–±–æ—Ç–µ").
        *   –ò–º—è –Ω–∞–∑–Ω–∞—á–µ–Ω–Ω–æ–≥–æ –∏–Ω–∂–µ–Ω–µ—Ä–∞ (–µ—Å–ª–∏ –∑–∞—è–≤–∫–∞ "–í —Ä–∞–±–æ—Ç–µ").
        *   –ù–∞—á–∞–ª–æ –æ–ø–∏—Å–∞–Ω–∏—è –ø—Ä–æ–±–ª–µ–º—ã.

4.  **–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–º–æ—â–∏ (`/help`):**
    *   –í—ã–≤–æ–¥–∏—Ç —Å–ø—Ä–∞–≤–æ—á–Ω–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ —Å –æ–ø–∏—Å–∞–Ω–∏–µ–º –æ—Å–Ω–æ–≤–Ω—ã—Ö –∫–æ–º–∞–Ω–¥ –∏ –∫–Ω–æ–ø–æ–∫, –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∫–ª–∏–µ–Ω—Ç—É.

5.  **–û—Ç–º–µ–Ω–∞ —Ç–µ–∫—É—â–µ–≥–æ –¥–µ–π—Å—Ç–≤–∏—è (–ö–Ω–æ–ø–∫–∞ "‚ùå –û—Ç–º–µ–Ω–∞"):**
    *   –ü–æ—è–≤–ª—è–µ—Ç—Å—è –≤–æ –≤—Ä–µ–º—è –ø—Ä–æ—Ü–µ—Å—Å–∞ —Å–æ–∑–¥–∞–Ω–∏—è –∑–∞—è–≤–∫–∏ (FSM).
    *   –ü–æ–∑–≤–æ–ª—è–µ—Ç –ø—Ä–µ—Ä–≤–∞—Ç—å –≤–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö –∏ –≤–µ—Ä–Ω—É—Ç—å—Å—è –≤ –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é.

**–¢–≤–æ–∏ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏–∏ –∫–∞–∫ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞:**

*   **–¢–≤–æ—è –æ—Å–Ω–æ–≤–Ω–∞—è —Ä–æ–ª—å** ‚Äî –æ—Ç–≤–µ—á–∞—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π *–æ —Ç–æ–º, –∫–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è —ç—Ç–∏–º –±–æ—Ç–æ–º*. –û–±—ä—è—Å–Ω—è–π –Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ –∫–æ–º–∞–Ω–¥ –∏ –∫–Ω–æ–ø–æ–∫, –µ—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç.
*   –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç **—Å–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É**, –≤–µ–∂–ª–∏–≤–æ –ø—Ä–µ–¥–ª–æ–∂–∏ –µ–º—É –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "üìù –°–æ–∑–¥–∞—Ç—å –∑–∞—è–≤–∫—É" –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É `/new_request`. **–ù–µ –ø—ã—Ç–∞–π—Å—è –ø—Ä–∏–Ω—è—Ç—å –∑–∞—è–≤–∫—É –∏–ª–∏ —Å–æ–±—Ä–∞—Ç—å –¥–µ—Ç–∞–ª–∏ –ø—Ä–æ–±–ª–µ–º—ã —Å–∞–º–æ—Å—Ç–æ—è—Ç–µ–ª—å–Ω–æ –≤ —Å–≤–æ–±–æ–¥–Ω–æ–π —Ñ–æ—Ä–º–µ!** –ù–∞–ø—Ä–∞–≤–ª—è–π –µ–≥–æ –Ω–∞ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ –≤—Å—Ç—Ä–æ–µ–Ω–Ω–æ–≥–æ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–∞ –±–æ—Ç–∞.
*   –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç **—Å—Ç–∞—Ç—É—Å —Å–≤–æ–∏—Ö –∑–∞—è–≤–æ–∫** –∏–ª–∏ —Ö–æ—á–µ—Ç –∏—Ö –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å, –ø–æ—Å–æ–≤–µ—Ç—É–π –µ–º—É –Ω–∞–∂–∞—Ç—å –∫–Ω–æ–ø–∫—É "üìÑ –ú–æ–∏ –∑–∞—è–≤–∫–∏" –∏–ª–∏ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å –∫–æ–º–∞–Ω–¥—É `/my_requests`.
*   **–ù–µ –¥–∞–≤–∞–π —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–∏—Ö —Å–æ–≤–µ—Ç–æ–≤** –ø–æ —Ä–µ–º–æ–Ω—Ç—É –∏–ª–∏ –¥–∏–∞–≥–Ω–æ—Å—Ç–∏–∫–µ –ø—Ä–æ–±–ª–µ–º. –¢–≤–æ—è –∑–∞–¥–∞—á–∞ ‚Äî –ø–æ–º–æ—á—å –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞—è–≤–∫—É —á–µ—Ä–µ–∑ –±–æ—Ç–∞, –∞ –Ω–µ —Ä–µ—à–∞—Ç—å —Å–∞–º—É –ø—Ä–æ–±–ª–µ–º—É. –í–µ–∂–ª–∏–≤–æ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–∞ —Å–æ–∑–¥–∞–Ω–∏–µ –∑–∞—è–≤–∫–∏, –µ—Å–ª–∏ –æ–Ω –æ–ø–∏—Å—ã–≤–∞–µ—Ç —Ç–µ—Ö–Ω–∏—á–µ—Å–∫—É—é –ø—Ä–æ–±–ª–µ–º—É.
*   **–ù–µ —Å–æ–æ–±—â–∞–π** –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –¥—Ä—É–≥–∏—Ö –∑–∞—è–≤–∫–∞—Ö, –∏–Ω–∂–µ–Ω–µ—Ä–∞—Ö –∏–ª–∏ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ã—Ö —Ñ—É–Ω–∫—Ü–∏—è—Ö (–¥–∞–∂–µ –µ—Å–ª–∏ –∑–Ω–∞–µ—à—å –æ –Ω–∏—Ö –∏–∑ —ç—Ç–æ–≥–æ –ø—Ä–æ–º–ø—Ç–∞). –¢–≤–æ–∏ –æ—Ç–≤–µ—Ç—ã –¥–æ–ª–∂–Ω—ã –±—ã—Ç—å —Å—Ç—Ä–æ–≥–æ —Å –ø–æ–∑–∏—Ü–∏–∏ –ø–æ–º–æ—â–∏ –∫–ª–∏–µ–Ω—Ç—É –≤ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–∏ *–µ–≥–æ* —Ñ—É–Ω–∫—Ü–∏–π –±–æ—Ç–∞.
*   **–ù–µ –≤—ã–ø–æ–ª–Ω—è–π –¥–µ–π—Å—Ç–≤–∏—è** –æ—Ç –∏–º–µ–Ω–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–µ —Å–æ–∑–¥–∞–≤–∞–π, –Ω–µ –∏–∑–º–µ–Ω—è–π, –Ω–µ –æ—Ç–º–µ–Ω—è–π –∑–∞—è–≤–∫–∏).
*   –ï—Å–ª–∏ –≤–æ–ø—Ä–æ—Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è **–Ω–µ –∫–∞—Å–∞–µ—Ç—Å—è** –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ –±–æ—Ç–∞ –¥–ª—è –ø–æ–¥–∞—á–∏ –∑–∞—è–≤–æ–∫ –Ω–∞ —Ä–µ–º–æ–Ω—Ç, –≤–µ–∂–ª–∏–≤–æ —Å–æ–æ–±—â–∏, —á—Ç–æ —Ç—ã –º–æ–∂–µ—à—å –ø–æ–º–æ—á—å —Ç–æ–ª—å–∫–æ —Å –≤–æ–ø—Ä–æ—Å–∞–º–∏ –ø–æ —Ä–∞–±–æ—Ç–µ —Å –±–æ—Ç–æ–º —Å–ª—É–∂–±—ã –ø–æ–¥–¥–µ—Ä–∂–∫–∏.
*   –û—Ç–≤–µ—á–∞–π **–∫—Ä–∞—Ç–∫–æ, —è—Å–Ω–æ –∏ –≤—Å–µ–≥–¥–∞ –≤–µ–∂–ª–∏–≤–æ**.

–ü–æ–º–Ω–∏, —Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å –∫ –±–æ—Ç—É, –ø–æ–º–æ–≥–∞—é—â–∏–π –∫–ª–∏–µ–Ω—Ç–∞–º —Å–æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞—Ç—å—Å—è –≤ –µ–≥–æ —Ñ—É–Ω–∫—Ü–∏—è—Ö. –ù–æ —Ç–∞–∫–∂–µ —Ç—ã –º–æ–∂–µ—à—å –¥–∞–≤–∞—Ç—å –∫—Ä–∞—Ç–∫–∏–µ —Å–æ–≤–µ—Ç—ã, –µ—Å–ª–∏ —Ç–µ–±—è –æ –Ω–∏—Ö –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ —Å–ø—Ä–∞—à–∏–≤–∞—é—Ç.
"""

async def get_yagpt_response(user_message: str) -> str | None:
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –∑–∞–ø—Ä–æ—Å –∫ YandexGPT –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ—Ç –æ—Ç–≤–µ—Ç.
    –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç None –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏.
    """
    if not is_gpt_enabled or not YAGPT_API_KEY or not YAGPT_FOLDER_ID:
        logging.warning("YandexGPT call attempt while disabled or not configured.")
        return None

    payload = {
        "modelUri": MODEL_URI,
        "completionOptions": {
            "stream": False, # –ü–æ—Ç–æ–∫–æ–≤–∞—è –ø–µ—Ä–µ–¥–∞—á–∞ –ø–æ–∫–∞ –Ω–µ –Ω—É–∂–Ω–∞
            "temperature": 0.6, # –ö—Ä–µ–∞—Ç–∏–≤–Ω–æ—Å—Ç—å –æ—Ç–≤–µ—Ç–∞
            "maxTokens": "1000" # –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Ç–æ–∫–µ–Ω–æ–≤ –≤ –æ—Ç–≤–µ—Ç–µ
        },
        "messages": [
            {"role": "system", "text": SYSTEM_PROMPT},
            {"role": "user", "text": user_message}
            # –°—é–¥–∞ –º–æ–∂–Ω–æ –¥–æ–±–∞–≤–ª—è—Ç—å –∏—Å—Ç–æ—Ä–∏—é –¥–∏–∞–ª–æ–≥–∞ –¥–ª—è –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
        ]
    }

    try:
        async with aiohttp.ClientSession() as session:
            async with session.post(YAGPT_API_URL, headers=HEADERS, json=payload) as response:
                if response.status == 200:
                    result = await response.json()
                    # logging.debug(f"YandexGPT response payload: {result}") # –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
                    # –ò–∑–≤–ª–µ–∫–∞–µ–º —Ç–µ–∫—Å—Ç –æ—Ç–≤–µ—Ç–∞ –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç–∞
                    if result.get("result") and result["result"].get("alternatives"):
                        assistant_message = result["result"]["alternatives"][0].get("message", {}).get("text")
                        if assistant_message:
                            logging.info(f"Received YandexGPT response (first 50 chars): {assistant_message[:50]}...")
                            return assistant_message
                        else:
                             logging.warning("YandexGPT response structure error: Assistant message text not found.")
                    else:
                        logging.warning(f"YandexGPT response structure error: 'result' or 'alternatives' not found. Payload: {result}")
                    return "–ò–∑–≤–∏–Ω–∏—Ç–µ, –Ω–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –æ—Ç–≤–µ—Ç –æ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏."
                else:
                    error_text = await response.text()
                    logging.error(f"YandexGPT API request failed with status {response.status}: {error_text}")
                    return f"–ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –Ω–µ–π—Ä–æ—Å–µ—Ç–∏ (–ö–æ–¥: {response.status}). –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ."
    except aiohttp.ClientConnectorError as e:
        logging.error(f"YandexGPT connection error: {e}")
        return "–ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–µ—Ä–≤–∏—Å—É –Ω–µ–π—Ä–æ—Å–µ—Ç–∏."
    except json.JSONDecodeError as e:
        logging.error(f"YandexGPT JSON decode error: {e}")
        return "–û—à–∏–±–∫–∞ –æ–±—Ä–∞–±–æ—Ç–∫–∏ –æ—Ç–≤–µ—Ç–∞ –æ—Ç –Ω–µ–π—Ä–æ—Å–µ—Ç–∏."
    except Exception as e:
        logging.error(f"Unexpected error during YandexGPT request: {e}", exc_info=True)
        return "–ü—Ä–æ–∏–∑–æ—à–ª–∞ –Ω–µ–ø—Ä–µ–¥–≤–∏–¥–µ–Ω–Ω–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞–±–æ—Ç–µ —Å –Ω–µ–π—Ä–æ—Å–µ—Ç—å—é."

def enable_gpt():
    """–í–∫–ª—é—á–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ YandexGPT."""
    global is_gpt_enabled
    if not YAGPT_API_KEY or not YAGPT_FOLDER_ID:
        logging.warning("Cannot enable YandexGPT: API Key or Folder ID missing.")
        return False
    is_gpt_enabled = True
    logging.info("YandexGPT integration enabled.")
    return True

def disable_gpt():
    """–í—ã–∫–ª—é—á–∞–µ—Ç –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ YandexGPT."""
    global is_gpt_enabled
    is_gpt_enabled = False
    logging.info("YandexGPT integration disabled.")

def get_gpt_status() -> bool:
    """–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç —Ç–µ–∫—É—â–∏–π —Å—Ç–∞—Ç—É—Å (–≤–∫–ª—é—á–µ–Ω/–≤—ã–∫–ª—é—á–µ–Ω)."""
    return is_gpt_enabled